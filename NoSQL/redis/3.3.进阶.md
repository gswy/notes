## 事务

### 说明

> Redis中的`事务`（**transaction**）是一组命令的集合。`事务`命令一样都是redis的最小执行单位，一个`事务`中的命令要么都执行，要么都不执行。`事务`的原理是先将一个事务命令发送给redis，然后再让redis依次执行这些命令。例如：

```shell
$redis> MULIT
OK
$redis> SADD "user:1:like" 2
QUEUED
$redis> SADD "user:2:like" 1
QUEUED
$redis> EXEC
1) (integer) 1
2) (integer) 1
```

> 上面代码演示了`事务`使用方式，首先使用MULTI命令告诉redis：需要执行两个命令，先暂存起来，先不执行，暂存起来。而`EXEC`命令告诉redis执行，发送命令的顺序和执行的顺序一致。redis保证一个事务中的所有命令都执行，要么都不执行。如果发送`EXEC`命令前客户端断线，则redis会清空事务队列，事务中所有命令不会执行。一旦发送了`EXEC`客户端掉线也灭关系，redis已经记录了所有要执行的命令。
>
> 注意！redis事务没有提供回滚功能。为此开发者必须在事务执行出错后自己回复执行前的状态。

### 错误处理

1. 语法错误。语法错误指命令不存在或者参数个数不对redis抛出的错误。
2. 运行错误。运行错误指在执行命令时出现的错误，例如使用哈希类型的命令操作集合类型键，这种在实际执行前redis是无法发现的。如果事务里的一条命令出现了运行错误，事务里其他命令依然会继续执行。

###  WATCH命令

> 在一个事务中，我们只有在执行后才能拿到每个结果的返回值，但是有些情况下，我们需要先获取一条命令的返回值，根据返回值再执行下一条命令。`WATCH`命令可以监控一个或者多个键，一旦其中有一个键被更改或者删除，之后的事务就不会执行，监控一直持续到`EXEC`命令（事务中的命令时收到`EXEC`才执行的，所以在`MULTI`命令后可以修改`WATCH`命令监控的键值）。例如

```shell
$redis> SET key 1
OK
$redis> WATCH key
OK
$redis> SET key 2
OK
$redis> MULTI
OK
$redis> SET key 3
QUEUED
$redis> EXEC
(nil)
$redis> GET key
"2"
```

> 上面的例子中在WATCH命令执行后、事务执行前修改了key的值（即SET key 2），所以最后事务中的命令SET key 3没有执行，EXEC命令返回空结果。



## 过期时间

> 在实际开发中，我们经常遇到一些有时效性的数据，比如限时优惠活动，缓存，验证码等。过了一定的时间就需要删除这些数据。redis中可以使用`EXPIRE`命令设置一个键的过期时间，到期后redis会自动删除它。

```shell
# 给键设置过期时间，单位为秒，返回1表示设置成功，0表示键不存在或者设置失败。
EXPIRE key seconds

# 给键设置过期时间，单位毫秒
PEXPIRE key ms

# 如果想要知道一个键还有多久会被删除，可以使用TTL命令。
# 当键已过期或者不存在的时候，TTL命令返回-2
# 当键没有设置过期时间（即永久存在），TTL命令返回-1
TTL key

# 查看键还有多少毫秒过期
PTTL key
```



## 队列





## “发布/订阅”模式





## 管道





## 排序（待更新）



